// <auto-generated/>
#nullable enable

using System;
using System.Threading.Tasks;
using Zylance.Core.Controllers.Services;
using Zylance.Core.Controllers.Utils;
using Zylance.Core.Utils;

namespace {{ namespace }};

/// <summary>
///     Generated registration extension for {{ class_name }}
/// </summary>
public static partial class RouterServiceExtensions
{
    public static RouterService Register{{ class_name }}(
        this RouterService router,
        {{ full_type_name }} controller)
    {
        {{#each handlers}}
            {{#if (eq type "Request")}}
                // Request Handler Registration
    
                {{#if action}}
                    var action = "{{ action }}";
                {{else}}
                    // Auto-detect action from protobuf types
                    var reqAction = ProtoActionUtils.GetAction<{{ request_type }}>();
                    var resAction = ProtoActionUtils.GetAction<{{ response_type }}>();
            
                    if (string.IsNullOrEmpty(reqAction))
                        throw new InvalidOperationException(
                            "Cannot auto-detect action for method {{ method_name }}: " +
                            "Request type {{ request_type }} is missing the (action) option in its .proto definition.");
            
                    if (string.IsNullOrEmpty(resAction))
                        throw new InvalidOperationException(
                            "Cannot auto-detect action for method {{ method_name }}: " +
                            "Response type {{ response_type }} is missing the (action) option in its .proto definition.");
            
                    if (reqAction != resAction)
                        throw new InvalidOperationException(
                            "Action mismatch for method {{ method_name }}: " +
                            $"Request type has action '{reqAction}' but Response type has action '{resAction}'.");
            
                    var action = reqAction;
                {{/if}}
        
                router.Use(action, RequestHandlerUtils.{{#if is_async}}Wrap{{else}}WrapSync{{/if}}<{{ request_type }}, {{ response_type }}>(
                    controller.{{ method_name }}));
            {{/if}}
            
            {{#if (eq type "Event")}}
                // Event Handler Registration
                
                {{#if action}}
                    var eventName = "{{ action }}";
                {{else}}
                    // Auto-detect event name from protobuf type
                    var eventName = ProtoActionUtils.GetEventName<{{ event_type }}>();
            
                    if (string.IsNullOrEmpty(eventName))
                        throw new InvalidOperationException(
                            "Cannot auto-detect eventName for method {{ method_name }}: " +
                            "Event type {{ event_type }} is missing the (eventName) option in its .proto definition.");
                {{/if}}
            
                router.Use(eventName, EventHandlerUtils.{{#if is_async}}Wrap{{else}}WrapSync{{/if}}<{{ event_type }}>(
                    controller.{{ method_name }}));
            {{/if}}
        {{/each}}
    
        return router;
    }
}
